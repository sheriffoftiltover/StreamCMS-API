function htmlEncode(value){return String(value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}$.fn.loadImages=function(options){return options=$.extend({},{attr:"src"},options),this.find("img[data-"+options.attr+"]").each(function(){var img=$(this),url=img.data(options.attr);if(""!=url&&null!=url){var nimg=img.clone();nimg.one("load",function(){img.replaceWith(nimg)}),nimg.removeAttr(options.attr).removeAttr("data-"+options.attr).attr("src",url)}})},$.fn.sortElements=function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode,nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this)throw new Error("You can't sort elements if any one is a descendant of another.");parentNode.insertBefore(this,nextSibling),parentNode.removeChild(nextSibling)}});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this))})}}(),String.prototype.trim=function(){return $.trim(this)},String.prototype.replaceAll=function(find,replace){var str=this;return str.replace(new RegExp(find,"g"),replace)},String.prototype.format||(String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return"undefined"!=typeof args[number]?args[number]:match})}),destiny={cdn:"",token:"",baseUrl:"/",timeout:15e3,fn:{}},destiny.init=function(args){$.extend(destiny,args)},function($){var DestinyFeedConsumer=function(args){return this.args=$.extend({polling:null,init:$.noop(),success:$.noop(),error:$.noop(),pollexecute:$.noop(),type:"GET",dataType:"json",start:!0,ui:null},args),this.init()};$.extend(DestinyFeedConsumer.prototype,{polling:null,args:null,init:function(){if($.isFunction(this.args.init)&&this.args.init.call(this,this.args),null!=this.args.ui){if(null==$(this.args.ui).get(0))return;null!=$(this.args.ui).find(".loading").get(0)&&(this.args.start=!0)}return this.args.start&&this.load(),this.args.start=!0,this.setupPoll(),this},load:function(){return $.ajax(this.args),this},setupPoll:function(){var self=this;null!=self.polling&&self.stopPolling(),null!=self.args.polling&&"number"==typeof self.args.polling&&(self.polling=setInterval(function(){$.isFunction(self.args.pollexecute)&&!1===self.args.pollexecute.call(self,self.args)||self.load()},1e3*self.args.polling))},stopPolling:function(){clearInterval(this.polling)},resetPoll:function(){this.setupPoll()}}),window.DestinyFeedConsumer=DestinyFeedConsumer}(jQuery),$(function(){var popupDefaults={height:500,width:420,scrollbars:0,toolbar:0,location:0,status:"no",menubar:0,resizable:0,dependent:0};window.getOptionsString=function(options){options=options?$.extend({},popupDefaults,options):popupDefaults;var str="";for(var i in options)str+=i+"="+options[i]+",";return str},new DestinyFeedConsumer({url:destiny.baseUrl+"lastfm.json",polling:40,ifModified:!0,start:!1,ui:"#stream-lastfm",success:function(data,textStatus){if("notmodified"!=textStatus){var entries=$("#stream-lastfm .entries:first").empty();if(null!=data&&"object"==typeof data.recenttracks&&data.recenttracks.track.length>0){for(var i in data.recenttracks.track){if(3==i)break;var track=data.recenttracks.track[i],entry=$('<div class="media"><a class="pull-left cover-image" href="'+track.url+'"><img class="media-object" src="'+destiny.cdn+'/web/img/64x64.gif" data-src="'+track.image[1]["#text"]+'"></a><div class="media-body"><div class="media-heading trackname"><a title="'+htmlEncode(track.name)+'" href="'+track.url+'">'+htmlEncode(track.name)+'</a></div><div class="artist">'+htmlEncode(track.artist["#text"])+'</div><div class="details">'+(3>i&&""!=track.date_str?'<time class="pull-right" datetime="'+track.date_str+'">'+moment(track.date_str).fromNow()+"</time>":"")+(0==i&&""==track.date_str?'<time class="pull-right" datetime="'+track.date_str+'">now playing</time>':"")+'<small class="album subtle">'+track.album["#text"]+"</small></div></div></div>");entries.append(entry)}entries.loadImages()}}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"twitter.json",polling:300,ifModified:!0,start:!1,ui:"#stream-twitter",success:function(tweets,textStatus){if("notmodified"!=textStatus){var entries=$("#stream-twitter .entries:first").empty();for(var i in tweets){if(3==i)break;entries.append('<div class="media"><div class="media-body"><div class="media-heading"><a target="_blank" href="https://twitter.com/'+tweets[i].user.screen_name+"/status/"+tweets[i].id_str+'"><span class="glyphicon glyphicon-share"></span></a> '+tweets[i].html+'</div><time datetime="'+tweets[i].created_at+'" pubdate>'+moment(tweets[i].created_at).fromNow()+"</time></div></div>")}entries.loadImages()}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"youtube.json",ifModified:!0,start:!1,ui:"#youtube",success:function(data,textStatus){if("notmodified"!=textStatus){var ui=$("#youtube .thumbnails:first").empty();if(ui.removeClass("thumbnails-loading"),"object"==typeof data){for(var i in data.items){var title=htmlEncode(data.items[i].snippet.title);ui.append('<li><div class="thumbnail" data-toggle="tooltip" title="'+title+'"><a href="http://www.youtube.com/watch?v='+data.items[i].snippet.resourceId.videoId+'"><img alt="'+title+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="https://i.ytimg.com/vi/'+data.items[i].snippet.resourceId.videoId+'/default.jpg" /></a></div></li>'),ui.find(".thumbnail").tooltip({placement:"bottom"})}ui.loadImages()}}}}),new DestinyFeedConsumer({url:destiny.baseUrl+"broadcasts.json",polling:600,ifModified:!0,start:!1,ui:"#broadcasts",success:function(data,textStatus){if("notmodified"!=textStatus){var broadcasts=$("#broadcasts"),ui=broadcasts.find(".thumbnails:first").empty();if(ui.removeClass("thumbnails-loading"),null!=data&&void 0!=typeof data.videos){for(var i in data.videos){var time=moment(data.videos[i].recorded_at).fromNow();ui.append('<li><div class="thumbnail" data-placement="bottom" rel="tooltip" title="'+time+'"><a href="'+data.videos[i].url+'"><img alt="'+time+'" src="'+destiny.cdn+'/web/img/320x240.gif" data-src="'+data.videos[i].preview+'"></a></div></li>')}ui.loadImages(),ui.find('[data-toggle="tooltip"]').tooltip()}}}});var onlinebanner=$("#online-banner-view"),offlinebanner=$("#offline-banner-view"),statusbanners=$("#status-banners");new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,ifModified:!0,start:!1,ui:"body#home",success:function(data,textStatus){data&&"notmodified"!=textStatus&&(null!=data&&null!=data.stream?(onlinebanner.find(".preview a").attr("title",data.status),onlinebanner.find(".preview a").css("background-image","url("+data.stream.preview.medium+")"),onlinebanner.find(".live-info-game").text(data.game),onlinebanner.find(".live-info-updated").text(moment(data.stream.channel.updated_at).fromNow()),onlinebanner.find(".live-info-viewers").text(data.stream.viewers),onlinebanner.show().appendTo(statusbanners),offlinebanner.detach()):(offlinebanner.find(".offline-status").text(data.status),offlinebanner.find(".offline-info-lastbroadcast").text(moment(data.lastbroadcast).fromNow()),offlinebanner.find(".offline-info-game").text(data.game),data.previousbroadcast?offlinebanner.find(".preview a").css("background-image","url("+data.previousbroadcast.preview+")"):offlinebanner.find(".preview a").css("background-image","url("+data.video_banner+")"),offlinebanner.show().appendTo(statusbanners),onlinebanner.detach()))}});var pads=$(".private-ads .private-ad"),adRotateIndex=pads.length-1;setInterval(function(){$(pads[adRotateIndex]).fadeOut(500,function(){$(this).hide().removeClass("active")}),adRotateIndex<pads.length-1?adRotateIndex++:adRotateIndex=0,$(pads[adRotateIndex]).hide().addClass("active").fadeIn(500)},8e3);var gad=$("#google-ad");setTimeout(function(){("none"==gad.css("display")||parseInt(gad.height())<=0)&&gad.before('<div id="adblocker-message"><a>Add blocker</a><p>Please consider turning adblocker off for this website.</p></div>')},8e3),$("#twitchpanel").each(function(){$("#popoutchat").on("click",function(){return window.open("/embed/chat","_blank",window.getOptionsString()),$("body").addClass("nochat"),$("#chat-embed").remove(),$("#popoutchat,#popoutvideo").hide(),!1}),$("#popoutvideo").on("click",function(){return window.open("http://www.twitch.tv/destiny/popout","_blank",window.getOptionsString({height:420,width:720})),$("body").addClass("novideo"),$("#player-embed").remove(),$("#popoutchat,#popoutvideo").hide(),!1})}),$("body#bigscreen").each(function(){var chatpanel=$("#chat-panel"),streampanel=$("#stream-panel"),overlay=($("iframe#chat-frame"),$('<div class="overlay" />'));$("iframe#chat-frame").on("load",function(){var chatwindow=this.contentWindow;chatwindow&&$("#chat-panel-tools").each(function(){$(this).on("click","#popout",function(){return window.open("/embed/chat","_blank",window.getOptionsString()),$("body").addClass("nochat"),chatpanel.remove(),streampanel.removeAttr("style"),!1}),$(this).on("click","#refresh",function(){return chatwindow.location.reload(),!1}),$(this).on("click","#close",function(){return $("body").addClass("nochat"),chatpanel.remove(),streampanel.removeAttr("style"),!1})})}),$("#chat-panel-resize-bar").each(function(){var resizebar=$(this),minwidth=320,resizeFrames=function(nwidth){minwidth>nwidth&&(nwidth=minwidth),streampanel.css("width","-moz-calc(100% - "+nwidth+"px)"),streampanel.css("width","-webkit-calc(100% - "+nwidth+"px)"),streampanel.css("width","-o-calc(100% - "+nwidth+"px)"),streampanel.css("width","calc(100% - "+nwidth+"px)"),chatpanel.css("width",nwidth),resizebar.css("left",0),localStorage&&(localStorage["bigscreen.chat.width"]=nwidth)};resizebar.on("mousedown.chatresize",function(e){e.preventDefault(),resizebar.addClass("active"),overlay.appendTo("body");var offsetX=e.clientX,sx=resizebar.position().left;$(document).on("mouseup.chatresize",function(e){e.preventDefault(),resizebar.removeClass("active"),overlay.remove(),resizebar.css("left",sx+(e.clientX-offsetX)),$(document).unbind("mousemove.chatresize"),$(document).unbind("mouseup.chatresize"),resizeFrames(chatpanel.offset().left+chatpanel.outerWidth()-resizebar.offset().left)}),$(document).on("mousemove.chatresize",function(e){e.preventDefault(),resizebar.css("left",sx+(e.clientX-offsetX))})});var width=parseInt(localStorage["bigscreen.chat.width"]);width>minwidth&&resizeFrames(width)}),new DestinyFeedConsumer({url:destiny.baseUrl+"stream.json",polling:30,start:!0,ui:"#stream-panel .panelheader .game",ifModified:!0,success:function(data,textStatus){if("notmodified"!=textStatus){var ui=$("#stream-panel .panelheader .game");if(null!=data&&null!=data.stream)return void ui.html('<i class="icon-time icon-white subtle"></i> <span>Started '+moment(data.stream.channel.updated_at).fromNow()+"</span>"+(data.stream.channel.delay>0?" - "+parseInt(data.stream.channel.delay/60)+"m delay":"")).show();try{ui.html('<i class="icon-time icon-white subtle"></i> <span>Last broadcast ended '+moment(data.lastbroadcast).fromNow()+"</span>").show()}catch(e){ui.html('<i class="icon-time icon-white subtle"></i> <span>Broadcast has ended</span>').show()}}}})}),$(".collapse").collapse(),$(".collapsible").each(function(){var $c=$(this),$t=$c.find("> h3"),$v=$c.find("> content");$t.on("click",function(){$c.hasClass("active")?($t.find(">.expander").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-right"),$v.hide()):($t.find(">.expander").removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down"),$v.show()),$c.toggleClass("active")})}),""!==location.hash&&$('a[href="'+location.hash+'"]').tab("show"),$("body").each(function(){$('.navbar a[rel="'+$("body").attr("id")+'"]').closest("li").addClass("active"),$('.navbar a[rel="'+$("body").attr("class")+'"]').closest("li").addClass("active")}),$("body").on("click","a.popup",function(e){var a=$(this);return a.data("popup",window.open(a.attr("href"),"_blank",window.getOptionsString(a.data("options")))),e.preventDefault(),!1}),$(this).loadImages(),$(this).find('[data-toggle="tooltip"]').tooltip()}),function(){var applyMomentToElement=function(e){var ui=$(e),datetime=ui.data("datetime")||ui.attr("datetime")||ui.text(),format=ui.data("format")||"MMMM Do, h:mm:ss a";ui.data("moment-fromnow")?(ui.addClass("moment-update"),ui.html(moment(datetime).fromNow())):ui.html(moment(datetime).format(format)),ui.data("datetime",datetime).addClass("moment-set")};window.setInterval(function(){$("time.moment-update").each(function(){applyMomentToElement(this)})},3e4),$('time[data-moment="true"]:not(.moment-set)').each(function(){applyMomentToElement(this)})}(),function(){window.setInterval(function(){$.ajax({url:"/ping",method:"get"})},6e5)}(),function(){$.cookie.json=!0,$(".alert .close.persist").each(function(){var parent=$(this).parent(".alert"),id=parent.attr("id");id&&(id="alert-dismissed-"+id,$(this).click(function(){$.cookie(id,!0,{expires:365})}),$.cookie(id)&&parent.remove())})}(),function(){var fullscreenFn=function(fn,elem){for(var agents=["webkit","moz","ms","o",""],i=agents.length-1;i>=0;i--){var agent=agents[i],fullFn=null;if(fullFn=agent?agent+fn:fn.substr(0,1).toLowerCase()+fn.substr(1),"function"==typeof elem[fullFn]){elem[fullFn]();break}}},toggleFullscreen=function(event,element){document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen?(fullscreenFn("CancelFullScreen",document),$(element).removeClass("fullscreened")):(fullscreenFn("RequestFullScreen",element),$(element).addClass("fullscreened"))};$(document).on("fullscreenchange mozfullscreenchange webkitfullscreenchange",function(){document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||$(".fullscreened").removeClass("fullscreened")}),$(".stream-overlay.to-main").on("dblclick",function(e){return toggleFullscreen(e,$(this).parent().get(0)),!1}),$(".stream-overlay.fsbtn").on("click",function(e){return toggleFullscreen(e,$(this).parent().get(0)),!1})}(),function(){var usrSearch=$("#userSearchModal"),usrInput=usrSearch.find("input#userSearchInput"),usrSelectBtn=usrSearch.find("button#userSearchSelect"),usrSearchFrm=usrSearch.find("form#userSearchForm"),giftMsgInput=usrSearch.find("textarea#giftmessage"),hasErrors=!1,giftUsername="",checkUser=function(username,success){$.ajax({url:"/gift/check",data:{s:username},type:"GET",success:function(data){success.call(this,data)},error:function(){showLookupError("Error looking up user. Try again")}})},showLookupError=function(message){hasErrors=!0,usrSelectBtn.button("reset").attr("disabled",!0),usrSearch.find("label.error").text(message).removeClass("hidden")},cancelUserSelect=function(){usrSearch.modal("hide"),usrInput.val(""),giftMsgInput.val(""),$("#subscriptionGiftUsername").text(""),$("#giftSubscriptionConfirm").addClass("hidden"),$("#giftSubscriptionSelect").removeClass("hidden"),$('input[name="gift"]').val(""),$('input[name="gift-message"]').val("")},selectUser=function(username){usrSelectBtn.button("loading"),checkUser(username,function(response){response.valid&&response.cangift?(giftUsername=username,""==giftMsgInput.val()?giftMsgInput.focus():usrSearchFrm.submit(),usrSelectBtn.button("reset").attr("disabled",!1),hasErrors=!1):response.valid?response.cangift||showLookupError("This user is not eligible for a gift."):showLookupError("This user was not found. Try again.")})};usrInput.on("keydown change",function(){""==$(this).val()?usrSelectBtn.attr("disabled",!0):usrSelectBtn.attr("disabled",!1),usrSearch.find("label.error").addClass("hidden")}),usrSearchFrm.on("submit",function(){return usrSearch.find("label.error").addClass("hidden"),giftUsername!=usrInput.val()?selectUser(usrInput.val()):($("#subscriptionGiftUsername").text(usrInput.val()),$("#giftSubscriptionConfirm").removeClass("hidden"),$("#giftSubscriptionSelect").addClass("hidden"),$('input[name="gift"]').val(usrInput.val()),$('input[name="gift-message"]').val(giftMsgInput.val()),usrSearch.modal("hide")),!1}),usrSearch.on("shown.bs.modal",function(){usrInput.focus()}),usrSearch.on("hidden.bs.modal",function(){hasErrors&&(hasErrors=!1,giftUsername="",usrInput.val(""),giftMsgInput.val(""),usrSearch.find("label.error").addClass("hidden"))}),$("#cancelGiftSubscription").on("click",function(){return usrSearch.find("label.error").addClass("hidden"),cancelUserSelect(),!1})}(),$(function(){$("form#addressSaveForm").validate({rules:{fullName:{required:!0},line1:{required:!0},line2:{required:!0},city:{required:!0},region:{required:!0},zip:{required:!0},country:{required:!0}},highlight:function(element){$(element).closest(".form-group").addClass("error")},unhighlight:function(element){$(element).closest(".form-group").removeClass("error")}})});
//# sourceMappingURL=destiny.min.map